// --- AUTHENTICATION LOGIC ---

document.addEventListener('DOMContentLoaded', () => {
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const googleLoginBtn = document.getElementById('google-login-btn');
    const notification = document.getElementById('notification');

    // --- Check session on page load ---
    supabase.auth.onAuthStateChange((event, session) => {
        if (session) {
            // User is logged in, redirect to the main app
            window.location.href = 'app.html';
        }
    });

    // --- Show notification helper ---
    function showNotification(message, isError = false) {
        notification.textContent = message;
        notification.classList.remove('hidden', 'bg-red-500', 'bg-green-500');
        notification.classList.add(isError ? 'bg-red-500' : 'bg-green-500');
        setTimeout(() => {
            notification.classList.add('hidden');
        }, 3000);
    }

    // --- Email/Password Login ---
    if (loginForm) {
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginForm.email.value;
            const password = loginForm.password.value;

            const { error } = await supabase.auth.signInWithPassword({ email, password });

            if (error) {
                showNotification(error.message, true);
            } else {
                showNotification('Login bem-sucedido! A redirecionar...');
                // The onAuthStateChange listener will handle the redirect
            }
        });
    }

    // --- Email/Password Registration ---
    if (registerForm) {
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = registerForm.email.value;
            const password = registerForm.password.value;

            const { error } = await supabase.auth.signUp({ email, password });

            if (error) {
                showNotification(error.message, true);
            } else {
                showNotification('Registo bem-sucedido! Por favor, verifique o seu e-mail para confirmar.', false);
                registerForm.reset();
            }
        });
    }

    // --- Google Login ---
    if (googleLoginBtn) {
        googleLoginBtn.addEventListener('click', async () => {
            const { error } = await supabase.auth.signInWithOAuth({
                provider: 'google',
            });

            if (error) {
                showNotification(error.message, true);
            }
        });
    }
});

