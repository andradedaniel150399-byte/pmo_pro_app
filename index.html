<!DOCTYPE html>
<html lang="pt-BR" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PMO Pro - Gestão com IA e Rentabilidade</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'primary': { '50': '#fffbeb', '100': '#fef3c7', '200': '#fde68a', '300': '#fcd34d', '400': '#fbbf24', '500': '#f59e0b', '600': '#d97706', '700': '#b45309', '800': '#92400e', '900': '#78350f' },
                        'slate': { '50': '#f8fafc', '100': '#f1f5f9', '200': '#e2e8f0', '300': '#cbd5e1', '400': '#94a3b8', '500': '#64748b', '600': '#475569', '700': '#334155', '800': '#1e293b', '900': '#0f172a' },
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .chart-container { position: relative; width: 100%; height: 280px; max-height: 350px; }
        .kanban-column { min-width: 300px; max-width: 320px; }
        .widget { transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; }
        .widget .drag-handle { cursor: grab; }
        .widget:active { cursor: grabbing; }
        .widget-placeholder { background-color: rgba(100, 116, 139, 0.2); border: 2px dashed #94a3b8; border-radius: 0.75rem; }
        #notification-container { position: fixed; top: 1.5rem; right: 1.5rem; z-index: 1050; display: flex; flex-direction: column; gap: 0.75rem; }
        .notification { transition: all 0.3s ease-in-out; opacity: 0; transform: translateX(100%); }
        .notification.show { opacity: 1; transform: translateX(0); }
        .tab-button.active { border-color: #f59e0b; color: #f59e0b; }
        .dark .tab-button.active { border-color: #fbbf24; color: #fbbf24; }
        .overallocated { border-color: #ef4444 !important; background-color: #fee2e2; }
        .dark .overallocated { background-color: #450a0a; }
        .spinner { border: 2px solid #f3f3f3; border-top: 2px solid #f59e0b; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .widget-toggle { appearance: none; -webkit-appearance: none; position: relative; display: inline-block; width: 38px; height: 22px; background-color: #cbd5e1; border-radius: 9999px; transition: background-color .3s; cursor: pointer; }
        .dark .widget-toggle { background-color: #475569; }
        .widget-toggle::before { content: ''; position: absolute; top: 2px; left: 2px; width: 18px; height: 18px; background-color: white; border-radius: 50%; transition: transform .3s; }
        .widget-toggle:checked { background-color: #f59e0b; }
        .widget-toggle:checked::before { transform: translateX(16px); }
        .planner-cell { position: relative; overflow: visible; }
        .soft-allocation-pattern {
            background-image: repeating-linear-gradient(45deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.2) 10px, transparent 10px, transparent 20px);
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        }
        .planner-cell.sortable-ghost { background-color: #fde68a !important; }
        .draggable-project-item { cursor: grab; }
        .draggable-project-item:active { cursor: grabbing; }
        #loading-overlay { z-index: 2000; }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200">

    <div id="loading-overlay" class="fixed inset-0 bg-slate-900 bg-opacity-80 flex-col text-white flex items-center justify-center transition-opacity duration-300">
        <div class="spinner !w-12 !h-12 !border-4"></div>
        <p class="mt-4 text-lg font-semibold">Conectando ao PMO Pro...</p>
    </div>

    <div id="notification-container"></div>

    <!-- Modals -->
    <div id="project-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50 p-4">
        <div id="modal-content" class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-3xl transform transition-all duration-300 scale-95 opacity-0"></div>
    </div>
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center hidden">
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-md">
            <h3 class="text-lg font-bold">Confirmar Ação</h3>
            <div id="modal-message" class="mt-2 text-sm text-slate-600 dark:text-slate-400 space-y-2"></div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="modal-cancel-btn" class="px-4 py-2 bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-200 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-600">Cancelar</button>
                <button id="modal-confirm-btn" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">Confirmar</button>
            </div>
        </div>
    </div>

    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="w-20 lg:w-64 bg-slate-900 text-white flex flex-col transition-all duration-300">
            <div class="h-16 flex items-center justify-center lg:justify-start lg:pl-6 border-b border-slate-700/50">
                <span class="text-2xl font-bold text-primary-400">P</span><span class="hidden lg:inline ml-2 text-xl font-bold">PMO Pro</span>
            </div>
            <nav class="flex-1 px-2 lg:px-4 py-4 space-y-2">
                <a href="#" id="nav-dashboard" class="nav-item bg-slate-700 text-white flex items-center p-3 rounded-lg"><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/></svg><span class="hidden lg:inline ml-4 font-medium">Dashboard</span></a>
                <a href="#" id="nav-kanban" class="nav-item hover:bg-slate-700/50 flex items-center p-3 rounded-lg"><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a1 1 0 011-1h14a1 1 0 110 2H3a1 1 0 01-1-1z"/></svg><span class="hidden lg:inline ml-4 font-medium">Kanban</span></a>
                <a href="#" id="nav-planner" class="nav-item hover:bg-slate-700/50 flex items-center p-3 rounded-lg"><svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg><span class="hidden lg:inline ml-4 font-medium">Planejador</span></a>
                <a href="#" id="nav-portfolio" class="nav-item hover:bg-slate-700/50 flex items-center p-3 rounded-lg"><svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg><span class="hidden lg:inline ml-4 font-medium">Portfólio</span></a>
                <a href="#" id="nav-profitability" class="nav-item hover:bg-slate-700/50 flex items-center p-3 rounded-lg"><svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path></svg><span class="hidden lg:inline ml-4 font-medium">Rentabilidade</span></a>
                <a href="#" id="nav-forecast" class="nav-item hover:bg-slate-700/50 flex items-center p-3 rounded-lg"><svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg><span class="hidden lg:inline ml-4 font-medium">Forecast</span></a>
                <a href="#" id="nav-capacity" class="nav-item hover:bg-slate-700/50 flex items-center p-3 rounded-lg"><svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg><span class="hidden lg:inline ml-4 font-medium">Capacidade</span></a>
                <a href="#" id="nav-management" class="nav-item hover:bg-slate-700/50 flex items-center p-3 rounded-lg"><svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg><span class="hidden lg:inline ml-4 font-medium">Gestão</span></a>
                <a href="#" id="nav-settings" class="nav-item hover:bg-slate-700/50 flex items-center p-3 rounded-lg"><svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg><span class="hidden lg:inline ml-4 font-medium">Configurações</span></a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <header class="h-16 bg-white dark:bg-slate-800/50 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between px-6">
                <h1 id="view-title" class="text-xl font-semibold">Dashboard</h1>
                <div class="flex items-center space-x-4">
                    <div id="personalize-container" class="relative">
                        <button id="personalize-btn" class="flex items-center space-x-2 text-sm font-medium p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700">
                            <span>Personalizar</span><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div id="personalize-menu" class="hidden absolute right-0 mt-2 w-72 bg-white dark:bg-slate-800 rounded-lg shadow-xl z-10 border dark:border-slate-700">
                            <div class="p-4 border-b dark:border-slate-700"><p class="font-semibold">Personalizar Dashboard</p></div>
                            <div id="widget-toggles" class="p-4 max-h-96 overflow-y-auto"></div>
                        </div>
                    </div>
                    <div id="user-profile" class="hidden items-center space-x-3">
                        <span id="user-name" class="text-sm font-medium"></span>
                        <img id="user-photo" class="w-8 h-8 rounded-full" src="" alt="User photo">
                    </div>
                    <button id="login-btn" class="text-sm bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12.0001 2.00002L12.0001 2.00002C17.523 2.00002 22.0001 6.47717 22.0001 12.0001C22.0001 17.523 17.523 22.0001 12.0001 22.0001C6.47717 22.0001 2.00002 17.523 2.00002 12.0001C2.00002 6.47717 6.47717 2.00002 12.0001 2.00002ZM12.0001 4.00002C7.58187 4.00002 4.00002 7.58187 4.00002 12.0001C4.00002 16.4183 7.58187 20.0001 12.0001 20.0001C16.4183 20.0001 20.0001 16.4183 20.0001 12.0001C20.0001 7.58187 16.4183 4.00002 12.0001 4.00002ZM12.0001 11.5C10.6194 11.5 9.50002 10.3807 9.50002 9.00002C9.50002 7.61931 10.6194 6.50002 12.0001 6.50002C13.3808 6.50002 14.5001 7.61931 14.5001 9.00002C14.5001 10.3807 13.3808 11.5 12.0001 11.5ZM7.7668 17.0324C8.55393 15.6588 10.151 14.5 12.0001 14.5C13.8492 14.5 15.4462 15.6588 16.2334 17.0324C15.0354 17.8329 13.5823 18.2501 12.0001 18.2501C10.4179 18.2501 8.96476 17.8329 7.7668 17.0324Z"></path></svg>
                        Entrar
                    </button>
                    <button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700">
                        <svg id="theme-icon-light" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                        <svg id="theme-icon-dark" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                    </button>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-6">
                <div id="view-dashboard" class="view-content"><div id="dashboard-grid" class="grid grid-cols-1 md:grid-cols-4 gap-6"></div></div>
                <div id="view-kanban" class="view-content hidden"><div id="kanban-board" class="flex space-x-4 overflow-x-auto pb-4"></div></div>
                <div id="view-planner" class="view-content hidden">
                    <div class="flex flex-col lg:flex-row gap-6">
                        <!-- Draggable Projects -->
                        <div class="lg:w-80">
                            <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm h-full">
                                <h3 class="font-semibold mb-3">Projetos para Alocar</h3>
                                <div id="planner-projects-list" class="space-y-2 max-h-[70vh] overflow-y-auto pr-2">
                                    <!-- Projects will be rendered here by JS -->
                                </div>
                            </div>
                        </div>
                        <!-- Planner Grid -->
                        <div class="flex-1">
                             <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="font-semibold">Planejador Visual de Capacidade</h3>
                                    <input type="month" id="planner-month-picker" class="bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-sm rounded-lg p-2">
                                </div>
                                <div id="planner-grid-container" class="overflow-x-auto"></div>
                             </div>
                        </div>
                    </div>
                </div>
                <div id="view-portfolio" class="view-content hidden space-y-6"><div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm overflow-x-auto"><div id="gantt-chart-container" class="min-w-[1000px]"></div></div></div>
                <div id="view-profitability" class="view-content hidden space-y-6">
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm"><h3 class="font-semibold mb-4">Análise de Rentabilidade de Projetos</h3><div class="chart-container"><canvas id="profitabilityChart"></canvas></div></div>
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm"><h3 class="font-semibold mb-4">Detalhes Financeiros</h3><div id="profitability-table-container" class="relative overflow-x-auto"></div></div>
                </div>
                <div id="view-forecast" class="view-content hidden space-y-6">
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm">
                        <div class="flex justify-between items-start">
                            <h3 class="font-semibold mb-4">Forecast de Receita</h3>
                            <button id="generate-forecast-btn" class="text-sm bg-primary-500 hover:bg-primary-600 text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2">✨ Gerar Forecast com IA</button>
                        </div>
                        <div id="forecast-content" class="hidden">
                            <div id="forecast-kpis" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"></div>
                            <div class="chart-container mb-6"><canvas id="forecastChart"></canvas></div>
                            <div id="gemini-forecast-analysis" class="text-sm text-slate-600 dark:text-slate-300 bg-slate-50 dark:bg-slate-800/50 p-4 rounded-lg"></div>
                        </div>
                        <div id="forecast-placeholder" class="text-center py-10 text-slate-500">Clique no botão para gerar um forecast de receita.</div>
                    </div>
                </div>
                <div id="view-capacity" class="view-content hidden space-y-6">
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm">
                        <div class="flex justify-between items-start"><h3 class="font-semibold mb-4">Análise de GAP de Capacidade</h3><button id="analyze-capacity-btn" class="text-sm bg-primary-500 hover:bg-primary-600 text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2">✨ Analisar Riscos</button></div>
                        <div class="chart-container"><canvas id="capacityGapChart"></canvas></div>
                        <div id="gemini-capacity-analysis" class="mt-4 text-sm text-slate-600 dark:text-slate-300 bg-slate-50 dark:bg-slate-800/50 p-4 rounded-lg hidden"></div>
                    </div>
                </div>
                <div id="view-management" class="view-content hidden space-y-6">
                    <div class="border-b border-slate-200 dark:border-slate-700"><nav class="-mb-px flex space-x-6"><button id="tab-btn-allocation" class="tab-button active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Alocação por Período</button><button id="tab-btn-cleanup" class="tab-button text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200 dark:hover:border-gray-500 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Limpeza de Alocações</button></nav></div>
                    <div id="tab-content-allocation" class="tab-content mt-6"><div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm"><div class="space-y-4"><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 items-end"><div><label class="text-sm font-medium">Profissional</label><select id="alloc-professional" class="mt-1 bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-sm rounded-lg block w-full p-2.5"></select></div><div><label class="text-sm font-medium">Data de Início</label><input type="date" id="alloc-start-date" class="mt-1 bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-sm rounded-lg block w-full p-2.5"></div><div><label class="text-sm font-medium">Data de Fim</label><input type="date" id="alloc-end-date" class="mt-1 bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-sm rounded-lg block w-full p-2.5"></div></div><div class="border-t border-slate-200 dark:border-slate-700 pt-4"><h4 class="font-semibold mb-2">Projetos e Horas para o Período</h4><div id="bulk-allocation-list" class="space-y-2"></div><button id="add-project-to-period-btn" class="mt-2 text-sm text-primary-600 hover:text-primary-800 dark:text-primary-400 dark:hover:text-primary-200 font-medium flex items-center gap-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>Adicionar Projeto</button></div><div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end border-t border-slate-200 dark:border-slate-700 pt-4"><div class="flex items-center space-x-2"><input type="checkbox" id="alloc-weekends" class="h-4 w-4 rounded border-gray-300"><label for="alloc-weekends" class="text-sm font-medium">Incluir fins de semana</label></div><div class="md:col-span-2"><button id="populate-period-btn" class="w-full bg-primary-600 hover:bg-primary-700 text-white font-bold py-2 px-6 rounded-lg">Popular Grade com Projetos</button></div></div></div><div id="allocation-calendar-container" class="mt-6"></div></div></div>
                    <div id="tab-content-cleanup" class="tab-content hidden mt-6"><div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm max-w-2xl mx-auto"><h3 class="font-semibold text-red-600 mb-4">Limpeza de Alocações</h3><div class="space-y-4"><div><label class="text-sm font-medium">Mês/Ano</label><input type="month" class="mt-1 bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-sm rounded-lg block w-full p-2.5"></div><div><label class="text-sm font-medium">Profissional</label><select id="cleanup-professional" class="mt-1 bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-sm rounded-lg block w-full p-2.5"><option>Todos</option></select></div><div><label class="text-sm font-medium">Projeto</label><select id="cleanup-project" class="mt-1 bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-sm rounded-lg block w-full p-2.5"><option>Todos</option></select></div><button id="cleanup-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Limpar Alocações</button></div></div></div>
                </div>
                <div id="view-settings" class="view-content hidden space-y-6">
                    <div class="border-b border-slate-200 dark:border-slate-700"><nav class="-mb-px flex space-x-6" id="settings-tabs"><button class="settings-tab-button active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="general">Geral</button><button class="settings-tab-button text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200 dark:hover:border-gray-500 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="team">Equipe e Custos</button><button class="settings-tab-button text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200 dark:hover:border-gray-500 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="integrations">Integrações</button></nav></div>
                    
                    <div id="settings-tab-general" class="settings-tab-content mt-6 space-y-6">
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm"><h3 class="font-semibold mb-4">Preferências da Aplicação</h3><div class="space-y-4 max-w-md"><div><label class="text-sm font-medium">Horas de Trabalho por Dia</label><p class="text-xs text-slate-500 mb-1">Define o limite para validação de superalocação.</p><input type="number" id="setting-work-hours" class="mt-1 bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-sm rounded-lg block w-full p-2.5"></div></div></div>
                    </div>
                    <div id="settings-tab-team" class="settings-tab-content hidden mt-6 space-y-6">
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm"><h3 class="font-semibold mb-4">Gestão da Equipe</h3><div id="professionals-list-container"></div><form id="add-professional-form" class="mt-4 flex gap-4 items-end p-4 bg-slate-50 dark:bg-slate-800/50 rounded-lg"><div class="flex-1"><label for="prof-name" class="text-sm font-medium">Nome</label><input type="text" id="prof-name" required class="mt-1 bg-white dark:bg-slate-700 border text-sm rounded-lg block w-full p-2.5"></div><div class="flex-1"><label for="prof-role" class="text-sm font-medium">Cargo</label><input type="text" id="prof-role" required class="mt-1 bg-white dark:bg-slate-700 border text-sm rounded-lg block w-full p-2.5"></div><div class="w-32"><label for="prof-cost" class="text-sm font-medium">Custo/Hora</label><input type="number" id="prof-cost" required class="mt-1 bg-white dark:bg-slate-700 border text-sm rounded-lg block w-full p-2.5"></div><button type="submit" class="bg-primary-600 hover:bg-primary-700 text-white font-bold py-2.5 px-4 rounded-lg">Adicionar</button></form></div>
                    </div>
                    <div id="settings-tab-integrations" class="settings-tab-content hidden mt-6 space-y-6">
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm"><h3 class="font-semibold mb-4">Integração com Pipefy</h3><div class="space-y-4 max-w-xl"><div><label for="pipefy-api-key" class="text-sm font-medium">Token da API</label><input type="password" id="pipefy-api-key" class="mt-1 bg-slate-50 dark:bg-slate-700 border text-sm rounded-lg block w-full p-2.5"></div><div><label for="pipefy-pipe-id" class="text-sm font-medium">ID do Pipe</label><input type="text" id="pipefy-pipe-id" class="mt-1 bg-slate-50 dark:bg-slate-700 border text-sm rounded-lg block w-full p-2.5"></div></div></div>
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm"><h3 class="font-semibold mb-4">Mapeamento de Siglas de Serviço</h3><div id="acronym-list-container"></div><form id="add-acronym-form" class="mt-4 flex gap-4 items-end p-4 bg-slate-50 dark:bg-slate-800/50 rounded-lg"><div class="flex-1"><label for="acronym-service" class="text-sm font-medium">Tipo de Serviço (Pipefy)</label><input type="text" id="acronym-service" required class="mt-1 bg-white dark:bg-slate-700 border text-sm rounded-lg block w-full p-2.5"></div><div class="w-32"><label for="acronym-code" class="text-sm font-medium">Sigla</label><input type="text" id="acronym-code" required class="mt-1 bg-white dark:bg-slate-700 border text-sm rounded-lg block w-full p-2.5"></div><button type="submit" class="bg-primary-600 hover:bg-primary-700 text-white font-bold py-2.5 px-4 rounded-lg">Adicionar</button></form></div>
                        <button id="save-settings-btn" class="w-full sm:w-auto bg-slate-800 hover:bg-slate-900 dark:bg-primary-600 dark:hover:bg-primary-700 text-white font-bold py-2 px-6 rounded-lg flex items-center justify-center gap-2">Salvar Configurações de Integração</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

<script type="module">
    // --- FIREBASE SDK IMPORTS ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, doc, onSnapshot, addDoc, deleteDoc, updateDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // --- STATE & CONFIG ---
    const state = {
        appId: typeof __app_id !== 'undefined' ? __app_id : 'pmo-pro-default',
        db: null,
        auth: null,
        userId: null,
        unsubscribeListeners: [],
        currentUser: null,
        currentView: 'dashboard',
        theme: localStorage.getItem('theme') || 'light',
        dashboardLayout: JSON.parse(localStorage.getItem('dashboardLayout')) || {
            order: ['kpi-revenue', 'kpi-pipeline', 'kpi-active', 'kpi-utilization', 'chart-revenue', 'chart-utilization'],
            widgets: {
                'kpi-revenue': { visible: true, size: 'col-span-1 md:col-span-1' },
                'kpi-pipeline': { visible: true, size: 'col-span-1 md:col-span-1' },
                'kpi-active': { visible: true, size: 'col-span-1 md:col-span-1' },
                'kpi-utilization': { visible: true, size: 'col-span-1 md:col-span-1' },
                'chart-revenue': { visible: true, size: 'col-span-1 md:col-span-2' },
                'chart-utilization': { visible: true, size: 'col-span-1 md:col-span-2' },
            }
        },
        data: {
            projects: [], professionals: [], allocations: [], comments: [],
            capacityData: { labels: ['Set', 'Out', 'Nov', 'Dez', 'Jan', 'Fev'], totalCapacity: [1280, 1344, 1280, 1216, 1344, 1216], allocated: [1100, 1050, 1150, 900, 700, 400] },
            settings: { workHoursPerDay: 8, pipefyApiKey: '', pipefyPipeId: '', serviceAcronyms: { 'Consultoria': 'CDR', 'Tax': 'TAX', 'Auditoria': 'AUD' } }
        }
    };
    
    const widgets = [
        { id: 'kpi-revenue', title: 'Receita (Ganhos)', type: 'kpi', content: () => `R$ ${state.data.projects.filter(p=>p.status==='Ganho').reduce((s,p)=>s+p.fees,0)/1000}k` },
        { id: 'kpi-pipeline', title: 'Pipeline (Propostas)', type: 'kpi', content: () => `R$ ${state.data.projects.filter(p=>p.status==='Proposta').reduce((s,p)=>s+p.fees,0)/1000}k` },
        { id: 'kpi-active', title: 'Projetos Ativos', type: 'kpi', content: () => state.data.projects.filter(p=>p.status==='Ativo').length },
        { id: 'kpi-utilization', title: 'Utilização Média', type: 'kpi', content: () => `${state.data.professionals.length > 0 ? Math.round(state.data.professionals.reduce((s,p)=>s+p.utilization,0)/state.data.professionals.length) : 0}%` },
        { id: 'chart-revenue', title: 'Receita por Status', type: 'chart', content: renderRevenueStatusChart },
        { id: 'chart-utilization', title: 'Utilização por Profissional', type: 'chart', content: renderUtilizationChart },
    ];

    // --- UI ELEMENTS ---
    const ui = {
        navItems: document.querySelectorAll('.nav-item'),
        views: document.querySelectorAll('.view-content'),
        viewTitle: document.getElementById('view-title'),
        themeToggle: document.getElementById('theme-toggle'),
        lightIcon: document.getElementById('theme-icon-light'),
        darkIcon: document.getElementById('theme-icon-dark'),
        projectModal: document.getElementById('project-modal'),
        projectModalContent: document.getElementById('modal-content'),
        confirmModal: document.getElementById('confirmation-modal'),
        confirmModalMsg: document.getElementById('modal-message'),
        confirmBtn: document.getElementById('modal-confirm-btn'),
        cancelBtn: document.getElementById('modal-cancel-btn'),
        dashboardGrid: document.getElementById('dashboard-grid'),
        kanbanBoard: document.getElementById('kanban-board'),
        personalizeBtn: document.getElementById('personalize-btn'),
        personalizeMenu: document.getElementById('personalize-menu'),
        personalizeContainer: document.getElementById('personalize-container'),
        widgetTogglesContainer: document.getElementById('widget-toggles'),
        pipefyApiKeyInput: document.getElementById('pipefy-api-key'),
        pipefyPipeIdInput: document.getElementById('pipefy-pipe-id'),
        saveSettingsBtn: document.getElementById('save-settings-btn'),
        analyzeCapacityBtn: document.getElementById('analyze-capacity-btn'),
        generateForecastBtn: document.getElementById('generate-forecast-btn'),
        loginBtn: document.getElementById('login-btn'),
        userProfile: document.getElementById('user-profile'),
        userName: document.getElementById('user-name'),
        userPhoto: document.getElementById('user-photo'),
        loadingOverlay: document.getElementById('loading-overlay'),
    };
    const titles = { dashboard: 'Dashboard', kanban: 'Kanban de Projetos', planner: 'Planejador Visual', portfolio: 'Portfólio de Projetos', profitability: 'Análise de Rentabilidade', forecast: 'Forecast de Receita', capacity: 'Análise de Capacidade', management: 'Gestão de Alocações', settings: 'Configurações' };

    // --- Gemini API Integration ---
    async function callGeminiAPI(prompt, jsonSchema = null, retries = 3, delay = 1000) {
        const apiKey = ""; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
        if (jsonSchema) { payload.generationConfig = { responseMimeType: "application/json", responseSchema: jsonSchema }; }
        for (let i = 0; i < retries; i++) {
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]) {
                    const text = result.candidates[0].content.parts[0].text;
                    return jsonSchema ? JSON.parse(text) : text;
                } else { throw new Error("Resposta da API inválida ou vazia."); }
            } catch (error) {
                if (i === retries - 1) { console.error("Erro ao chamar a API Gemini:", error); return null; }
                await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
            }
        }
    }

    // --- UTILITY FUNCTIONS ---
    function showNotification(message, type = 'success', duration = 3000) {
        const container = document.getElementById('notification-container');
        const notif = document.createElement('div');
        const colors = type === 'success' ? 'bg-emerald-500' : (type === 'error' ? 'bg-red-500' : 'bg-sky-500');
        notif.className = `notification ${colors} text-white text-sm font-bold px-4 py-3 rounded-lg shadow-md`;
        notif.textContent = message;
        container.appendChild(notif);
        setTimeout(() => notif.classList.add('show'), 10);
        setTimeout(() => { notif.classList.remove('show'); setTimeout(() => notif.remove(), 300); }, duration);
    }
    function showConfirmationModal(messages, onConfirm) {
        ui.confirmModalMsg.innerHTML = messages.map(msg => `<p>${msg}</p>`).join('');
        ui.confirmModal.classList.remove('hidden');
        ui.confirmBtn.onclick = () => { onConfirm(); hideConfirmationModal(); };
        ui.cancelBtn.onclick = () => hideConfirmationModal();
    }
    function hideConfirmationModal() { ui.confirmModal.classList.add('hidden'); }
    
    // --- FIREBASE INTEGRATION ---
    function listenToCollection(collectionName, onUpdate, onError) {
        if (!state.userId) return;
        const path = `artifacts/${state.appId}/users/${state.userId}/${collectionName}`;
        const unsubscribe = onSnapshot(collection(state.db, path), (snapshot) => {
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            onUpdate(data);
        }, (error) => {
            console.error(`Error listening to ${collectionName}:`, error);
            onError(error);
        });
        state.unsubscribeListeners.push(unsubscribe);
    }

    function setupDataListeners() {
        // Clear previous listeners to avoid duplicates on re-login
        state.unsubscribeListeners.forEach(unsub => unsub());
        state.unsubscribeListeners = [];

        listenToCollection('professionals', (data) => {
            state.data.professionals = data;
            renderProfessionalsList();
            populateAllDropdowns();
            if(state.currentView === 'planner') renderPlannerView();
        }, () => showNotification('Erro ao carregar equipe.', 'error'));
        
        listenToCollection('projects', (data) => {
            state.data.projects = data;
            renderAllViews();
            populateAllDropdowns();
        }, () => showNotification('Erro ao carregar projetos.', 'error'));
        
        listenToCollection('allocations', (data) => {
            state.data.allocations = data;
             if(['planner', 'profitability'].includes(state.currentView)) {
                 renderPlannerView();
                 renderProfitability();
            }
        }, () => showNotification('Erro ao carregar alocações.', 'error'));

        listenToCollection('comments', (data) => {
            state.data.comments = data;
            const modal = document.getElementById('project-modal');
            if (!modal.classList.contains('hidden')) {
                const projectId = modal.dataset.currentProject;
                if(projectId) renderComments(projectId);
            }
        }, () => showNotification('Erro ao carregar comentários.', 'error'));
    }

    // --- VIEW & THEME MANAGEMENT ---
    function switchView(viewId) {
        state.currentView = viewId;
        ui.viewTitle.textContent = titles[viewId];
        ui.navItems.forEach(item => {
            item.classList.remove('bg-slate-700', 'text-white');
            item.classList.add('hover:bg-slate-700/50');
        });
        const activeNavItem = document.getElementById(`nav-${viewId}`);
        if(activeNavItem) {
            activeNavItem.classList.add('bg-slate-700', 'text-white');
            activeNavItem.classList.remove('hover:bg-slate-700/50');
        }

        ui.views.forEach(view => view.classList.toggle('hidden', view.id !== `view-${viewId}`));
        ui.personalizeContainer.style.display = viewId === 'dashboard' ? 'flex' : 'none';

        if (viewId === 'planner') {
            renderDraggableProjectsList();
            renderPlannerView();
        }
    }
    function applyTheme() {
        if (state.theme === 'dark') {
            document.documentElement.classList.add('dark');
            ui.lightIcon.classList.add('hidden'); ui.darkIcon.classList.remove('hidden');
        } else {
            document.documentElement.classList.remove('dark');
            ui.lightIcon.classList.remove('hidden'); ui.darkIcon.classList.add('hidden');
        }
    }
    ui.themeToggle.addEventListener('click', () => {
        state.theme = state.theme === 'light' ? 'dark' : 'light';
        localStorage.setItem('theme', state.theme);
        applyTheme();
    });

    // --- RENDER FUNCTIONS (Adapted for Real-time Data) ---
    function renderAllViews() {
        renderDashboard(); renderKanbanBoard(); renderGanttChart();
        renderCapacityGapChart(); renderProfitability();
        if (state.currentView === 'planner') {
            renderDraggableProjectsList();
            renderPlannerView();
        }
    }
    function renderDashboard() {
        ui.dashboardGrid.innerHTML = '';
        state.dashboardLayout.order.forEach(widgetId => {
            const widgetConfig = state.dashboardLayout.widgets[widgetId];
            const widgetData = widgets.find(w => w.id === widgetId);
            if (!widgetConfig || !widgetData || !widgetConfig.visible) return;
            const widgetEl = document.createElement('div');
            widgetEl.id = widgetId;
            widgetEl.dataset.id = widgetId;
            widgetEl.className = `widget ${widgetConfig.size} bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm flex flex-col`;
            let contentHTML = '';
            if (widgetData.type === 'kpi') {
                contentHTML += `<h4 class="text-sm font-medium text-slate-500 dark:text-slate-400">${widgetData.title}</h4><p class="text-3xl font-bold text-primary-600 dark:text-primary-400 mt-1">${widgetData.content()}</p>`;
            } else if (widgetData.type === 'chart') {
                contentHTML += `<h3 class="font-semibold mb-4">${widgetData.title}</h3><div class="flex-grow chart-container"><canvas id="chart-${widgetId}"></canvas></div>`;
            }
            widgetEl.innerHTML = contentHTML;
            ui.dashboardGrid.appendChild(widgetEl);
            if (widgetData.type === 'chart') {
                widgetData.content(`chart-${widgetId}`);
            }
        });
    }
    function renderKanbanBoard() {
        const columns = { 'Proposta': [], 'Ganho': [], 'Ativo': [], 'Billed': [], 'Perdido': [] };
        const columnStyles = { 'Proposta': 'border-l-slate-400', 'Ganho': 'border-l-sky-500', 'Ativo': 'border-l-primary-500', 'Billed': 'border-l-emerald-500', 'Perdido': 'border-l-red-500' };
        state.data.projects.forEach(p => { if(columns[p.status]) columns[p.status].push(p); });
        ui.kanbanBoard.innerHTML = Object.keys(columns).map(colName => `<div class="kanban-column flex-shrink-0"><div class="flex justify-between items-center mb-3"><h3 class="font-semibold">${colName}</h3><span class="text-sm font-bold bg-slate-200 dark:bg-slate-700 px-2 py-1 rounded-full">${columns[colName].length}</span></div><div class="space-y-3 h-full pr-2">${columns[colName].map(p => `<div class="kanban-card bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md cursor-pointer border-l-4 ${columnStyles[p.status]}" data-project-id="${p.id}"><p class="font-bold mb-2">${p.name}</p><p class="text-xs text-slate-500 dark:text-slate-400">${p.client}</p><div class="flex justify-between items-center mt-3"><span class="text-sm font-semibold text-primary-600 dark:text-primary-400">R$ ${p.fees/1000}k</span><span class="text-xs font-medium">${p.director}</span></div></div>`).join('') || `<div class="text-center text-sm text-slate-400 pt-10">Nenhum projeto</div>`}</div></div>`).join('');
        document.querySelectorAll('.kanban-card').forEach(card => card.addEventListener('click', () => openProjectModal(card.dataset.projectId)));
    }
    function renderGanttChart() {
        const container = document.getElementById('gantt-chart-container');
        const timelineStart = new Date('2025-07-01'), timelineEnd = new Date('2026-02-28');
        const totalDuration = timelineEnd - timelineStart;
        const months = ['Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez', 'Jan', 'Fev'];
        let headerHTML = `<div class="grid grid-cols-12 gap-2 font-bold border-b pb-2 mb-2 text-sm"><div class="col-span-4">Projeto</div><div class="col-span-2">Diretor</div><div class="col-span-6"><div class="grid grid-cols-8 text-center">${months.map(m => `<div>${m}</div>`).join('')}</div></div></div>`;
        let projectsHTML = state.data.projects.map(p => {
            if (!p.start || !p.end) return '';
            const left = ((new Date(p.start) - timelineStart) / totalDuration) * 100;
            const width = ((new Date(p.end) - new Date(p.start)) / totalDuration) * 100;
            const statusColors = { 'Ativo': 'bg-primary-500', 'Ganho': 'bg-sky-500', 'Proposta': 'bg-slate-400', 'Billed': 'bg-emerald-500', 'Perdido': 'bg-red-400' };
            return `<div class="grid grid-cols-12 gap-2 items-center py-3 border-b border-slate-200 dark:border-slate-700 text-sm"><div class="col-span-4 font-medium">${p.name}</div><div class="col-span-2">${p.director}</div><div class="col-span-6 h-6 relative bg-slate-200 dark:bg-slate-700 rounded-full"><div title="${p.name}" class="absolute h-full ${statusColors[p.status]} rounded-full" style="left: ${left}%; width: ${width}%;"></div></div></div>`;
        }).join('');
        container.innerHTML = headerHTML + projectsHTML;
    }
    function renderProfessionalsList() {
        const container = document.getElementById('professionals-list-container');
        let tableHTML = `<table class="w-full text-sm text-left"><thead class="text-xs uppercase bg-slate-50 dark:bg-slate-700"><tr><th class="px-6 py-3">Nome</th><th class="px-6 py-3">Cargo</th><th class="px-6 py-3">Custo/Hora (R$)</th><th class="px-6 py-3"><span class="sr-only">Ação</span></th></tr></thead><tbody>`;
        if (state.data.professionals.length === 0) {
            tableHTML += `<tr><td colspan="4" class="text-center py-10 text-slate-500">Nenhum profissional cadastrado.</td></tr>`;
        } else {
            tableHTML += state.data.professionals.map(p => `
                <tr class="bg-white dark:bg-slate-800 border-b dark:border-slate-700"><th class="px-6 py-4 font-medium">${p.name}</th><td class="px-6 py-4">${p.role}</td>
                <td class="px-6 py-4"><input type="number" value="${p.cost}" data-id="${p.id}" class="prof-cost-input bg-slate-100 dark:bg-slate-700 p-1 rounded w-24"></td>
                <td class="px-6 py-4 text-right"><button data-id="${p.id}" class="remove-prof-btn font-medium text-red-600 hover:underline">Remover</button></td></tr>`).join('');
        }
        container.innerHTML = tableHTML + '</tbody></table>';
    }
    function renderProfitability() {
        const projectsWithProfit = state.data.projects.map(p => {
            const cost = state.data.allocations.filter(a => a.projectId === p.id).reduce((total, alloc) => {
                const professional = state.data.professionals.find(prof => prof.id === alloc.professionalId);
                return total + (alloc.hours * (professional?.cost || 0));
            }, 0);
            const profit = p.fees - cost;
            const margin = p.fees > 0 ? (profit / p.fees) * 100 : 0;
            return { ...p, cost, profit, margin };
        }).sort((a,b) => b.fees - a.fees);
        const chartData = projectsWithProfit.slice(0, 10);
        const ctx = document.getElementById('profitabilityChart').getContext('2d');
        if (charts.profit) charts.profit.destroy();
        charts.profit = new Chart(ctx, { type: 'bar', data: { labels: chartData.map(p => p.name), datasets: [ { label: 'Receita', data: chartData.map(p => p.fees), backgroundColor: '#38bdf8' }, { label: 'Custo', data: chartData.map(p => p.cost), backgroundColor: '#fb923c' }, { label: 'Lucro', data: chartData.map(p => p.profit), backgroundColor: '#34d399' } ] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { callback: v => `R$${v/1000}k` } } } } });
        const tableContainer = document.getElementById('profitability-table-container');
        let tableHTML = `<table class="w-full text-sm text-left"><thead class="text-xs uppercase bg-slate-50 dark:bg-slate-700"><tr><th class="px-6 py-3">Projeto</th><th class="px-6 py-3">Receita</th><th class="px-6 py-3">Custo</th><th class="px-6 py-3">Lucro</th><th class="px-6 py-3">Margem</th></tr></thead><tbody>`;
        tableHTML += projectsWithProfit.map(p => `<tr class="bg-white dark:bg-slate-800 border-b dark:border-slate-700"><th class="px-6 py-4 font-medium">${p.name}</th><td class="px-6 py-4">R$ ${p.fees.toLocaleString('pt-BR')}</td><td class="px-6 py-4">R$ ${p.cost.toLocaleString('pt-BR')}</td><td class="px-6 py-4 font-bold ${p.profit > 0 ? 'text-emerald-500' : 'text-red-500'}">R$ ${p.profit.toLocaleString('pt-BR')}</td><td class="px-6 py-4 font-bold ${p.margin > 20 ? 'text-emerald-500' : 'text-slate-500'}">${p.margin.toFixed(1)}%</td></tr>`).join('');
        tableContainer.innerHTML = tableHTML + '</tbody></table>';
    }
    function renderPlannerView() {
        const container = document.getElementById('planner-grid-container');
        const monthPicker = document.getElementById('planner-month-picker');
        if (!monthPicker.value) {
            const today = new Date();
            monthPicker.value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
        }
        const [year, month] = monthPicker.value.split('-').map(Number);
        const daysInMonth = new Date(year, month, 0).getDate();

        let table = `<table class="w-full text-sm text-left border-collapse">`;
        let header = `<thead><tr class="bg-slate-50 dark:bg-slate-700/50"><th class="sticky left-0 bg-slate-50 dark:bg-slate-700/50 p-2 border-b border-r border-slate-200 dark:border-slate-700 font-semibold z-10">Profissional</th>`;
        for(let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month - 1, day);
            const isWeekend = date.getDay() === 0 || date.getDay() === 6;
            header += `<th class="p-2 border-b border-slate-200 dark:border-slate-700 text-center font-medium ${isWeekend ? 'text-slate-400' : ''}">${day}</th>`;
        }
        header += `</tr></thead>`;
        table += header;

        let body = `<tbody>`;
        state.data.professionals.forEach(prof => {
            body += `<tr><td class="sticky left-0 bg-white dark:bg-slate-800 p-2 border-b border-r border-slate-200 dark:border-slate-700 font-semibold z-10">${prof.name}</td>`;
            for(let day = 1; day <= daysInMonth; day++) {
                const isoDate = `${year}-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                const allocations = state.data.allocations.filter(a => a.professionalId === prof.id && a.date === isoDate);
                const hardHours = allocations.filter(a => a.type === 'hard').reduce((sum, a) => sum + a.hours, 0);
                const softHours = allocations.filter(a => a.type === 'soft').reduce((sum, a) => sum + a.hours, 0);
                const totalHours = hardHours + softHours;
                
                let bgColor = 'bg-emerald-100/30 dark:bg-emerald-900/30';
                if (hardHours >= state.data.settings.workHoursPerDay) bgColor = 'bg-red-200/80 dark:bg-red-900/50';
                else if (hardHours > 0) bgColor = 'bg-amber-100/80 dark:bg-amber-900/50';

                const tooltip = `Confirmado: ${hardHours}h\nProvisório: ${softHours}h`;
                
                body += `<td class="planner-cell p-0 border-b border-slate-200 dark:border-slate-700 text-center text-xs h-12 ${bgColor}" title="${tooltip}" data-professional-id="${prof.id}" data-date="${isoDate}">`;
                if (totalHours > 0) {
                    body += `<div class="w-full h-full flex items-center justify-center font-bold text-slate-700 dark:text-slate-200">${hardHours > 0 ? hardHours : ''}${softHours > 0 ? `<span class="opacity-70">${hardHours > 0 ? '+' : ''}${softHours}</span>` : ''}</div>`;
                }
                if (softHours > 0 && hardHours === 0) {
                    body += `<div class="soft-allocation-pattern"></div>`;
                }
                body += `</td>`;
            }
            body += `</tr>`;
        });
        body += `</tbody>`;
        table += `</table>`;
        container.innerHTML = table;
        setupPlannerDragAndDrop();
    }
    
    function renderDraggableProjectsList() {
        const container = document.getElementById('planner-projects-list');
        if (!container) return;
        container.innerHTML = state.data.projects
            .filter(p => ['Ativo', 'Ganho'].includes(p.status))
            .map(p => `
                <div class="draggable-project-item bg-slate-100 dark:bg-slate-700/50 p-3 rounded-lg" data-project-id="${p.id}">
                    <p class="font-semibold text-sm">${p.name}</p>
                    <p class="text-xs text-slate-500 dark:text-slate-400">${p.client}</p>
                </div>
            `).join('');
        
        new Sortable(container, {
            group: { name: 'planner', pull: 'clone', put: false },
            sort: false,
            animation: 150,
        });
    }

    // --- CHART RENDERING ---
    let charts = {};
    function renderRevenueStatusChart(canvasId) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        const data = { 'Ganho': 0, 'Ativo': 0, 'Proposta': 0, 'Perdido': 0, 'Billed': 0 };
        state.data.projects.forEach(p => { if(data[p.status] !== undefined) data[p.status] += p.fees; });
        if (charts[canvasId]) charts[canvasId].destroy();
        charts[canvasId] = new Chart(ctx, { type: 'bar', data: { labels: Object.keys(data), datasets: [{ data: Object.values(data), backgroundColor: ['#0ea5e9', '#f59e0b', '#64748b', '#ef4444', '#10b981'], borderWidth: 0, borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { callback: v => `R$${v/1000}k` } }, x: { grid: { display: false } } } } });
    }
    function renderUtilizationChart(canvasId) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        if (charts[canvasId]) charts[canvasId].destroy();
        charts[canvasId] = new Chart(ctx, { type: 'bar', data: { labels: state.data.professionals.map(p => p.name), datasets: [{ data: state.data.professionals.map(p => p.utilization), backgroundColor: '#38bdf8', borderWidth: 0, borderRadius: 4 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, max: 100, grid: { display: false } } } } });
    }
    function renderCapacityGapChart() {
        const ctx = document.getElementById('capacityGapChart').getContext('2d');
        if (charts.capacity) charts.capacity.destroy();
        charts.capacity = new Chart(ctx, { type: 'bar', data: { labels: state.data.capacityData.labels, datasets: [ { label: 'Horas Alocadas', data: state.data.capacityData.allocated, backgroundColor: '#fb923c', }, { label: 'Horas Disponíveis', data: state.data.capacityData.totalCapacity.map((t, i) => t - state.data.capacityData.allocated[i]), backgroundColor: '#94a3b8', } ] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true, grid: { display: false } }, y: { stacked: true, beginAtZero: true } } } });
    }
    
    // --- EVENT LISTENERS & HANDLERS (Firebase-aware) ---
    function setupEventListeners() {
        ui.navItems.forEach(item => item.addEventListener('click', e => { e.preventDefault(); switchView(item.id.split('-')[1]); }));
        document.querySelectorAll('.tab-button').forEach(button => button.addEventListener('click', () => {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.toggle('hidden', c.id !== button.id.replace('btn', 'content')));
        }));
        document.getElementById('add-professional-form').addEventListener('submit', handleAddProfessional);
        document.getElementById('professionals-list-container').addEventListener('click', handleRemoveProfessional);
        document.getElementById('professionals-list-container').addEventListener('change', handleCostUpdate);
        document.getElementById('cleanup-btn').addEventListener('click', () => showNotification('Limpeza concluída.'));
        ui.analyzeCapacityBtn.addEventListener('click', handleCapacityAnalysis);
        ui.generateForecastBtn.addEventListener('click', handleGenerateForecast);
        document.getElementById('settings-tabs').addEventListener('click', (e) => {
            if (e.target.classList.contains('settings-tab-button')) {
                document.querySelectorAll('.settings-tab-button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                document.querySelectorAll('.settings-tab-content').forEach(c => c.classList.toggle('hidden', c.id !== `settings-tab-${e.target.dataset.tab}`));
            }
        });
        document.getElementById('planner-month-picker').addEventListener('change', renderPlannerView);
        document.getElementById('add-project-to-period-btn').addEventListener('click', handleAddProjectToPeriod);
        document.getElementById('populate-period-btn').addEventListener('click', handlePopulatePeriod);
        document.getElementById('allocation-calendar-container').addEventListener('input', handleAllocationInputChange);
        document.getElementById('allocation-calendar-container').addEventListener('click', handleAllocationCalendarClick);
        document.getElementById('bulk-allocation-list').addEventListener('click', e => { 
            if (e.target.classList.contains('remove-bulk-row-btn')) e.target.closest('.bulk-alloc-row').remove(); 
        });
        ui.saveSettingsBtn.addEventListener('click', handlePipefySync);
    }
    
    // --- HANDLER FUNCTIONS (Firebase-aware) ---
    async function handleAddProfessional(e) { 
        e.preventDefault(); 
        const name = document.getElementById('prof-name').value; 
        const role = document.getElementById('prof-role').value; 
        const cost = parseFloat(document.getElementById('prof-cost').value); 
        if (!name || !role || isNaN(cost)) { showNotification('Todos os campos são obrigatórios.', 'error'); return; }
        try {
            const path = `artifacts/${state.appId}/users/${state.userId}/professionals`;
            await addDoc(collection(state.db, path), { name, role, cost, utilization: 0 });
            e.target.reset(); 
            showNotification('Profissional adicionado com sucesso!');
        } catch (error) {
            console.error("Error adding professional: ", error);
            showNotification('Erro ao adicionar profissional.', 'error');
        }
    }
    async function handleRemoveProfessional(e) { 
        if (!e.target.classList.contains('remove-prof-btn')) return; 
        const idToRemove = e.target.dataset.id;
        showConfirmationModal(['Tem certeza que deseja remover este profissional?'], async () => {
            try {
                const path = `artifacts/${state.appId}/users/${state.userId}/professionals`;
                await deleteDoc(doc(state.db, path, idToRemove));
                showNotification('Profissional removido.');
            } catch (error) {
                console.error("Error removing professional: ", error);
                showNotification('Erro ao remover profissional.', 'error');
            }
        });
    }
    async function handleCostUpdate(e) {
        if (!e.target.classList.contains('prof-cost-input')) return; 
        const id = e.target.dataset.id;
        const newCost = parseFloat(e.target.value);
        if (isNaN(newCost)) return;
        try {
            const path = `artifacts/${state.appId}/users/${state.userId}/professionals`;
            await updateDoc(doc(state.db, path, id), { cost: newCost });
            showNotification(`Custo atualizado.`, 'info');
        } catch (error) {
            console.error("Error updating cost: ", error);
            showNotification('Erro ao atualizar custo.', 'error');
        }
    }
    async function handleAddAllocation(projectId, professionalId, date, hours, type) {
        try {
            const path = `artifacts/${state.appId}/users/${state.userId}/allocations`;
            await addDoc(collection(state.db, path), { professionalId, projectId, date, hours: parseFloat(hours), type });
            showNotification('Alocação salva!', 'success');
        } catch (error) {
            console.error("Error adding allocation: ", error);
            showNotification('Erro ao salvar alocação.', 'error');
        }
    }
    function handleAddProjectToPeriod() { 
        const listContainer = document.getElementById('bulk-allocation-list'); 
        const projectOptions = state.data.projects.map(p => `<option value="${p.id}">${p.name}</option>`).join(''); 
        const newRow = document.createElement('div'); 
        newRow.className = 'flex items-center gap-2 bulk-alloc-row'; 
        newRow.innerHTML = `<select class="bulk-project-select bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-sm rounded-lg block w-full p-2">${projectOptions}</select><input type="number" min="0" max="24" step="0.5" placeholder="Horas/dia" class="bulk-hours-input bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-sm rounded-lg block w-40 p-2"><button class="remove-bulk-row-btn text-red-500 hover:text-red-700 font-bold text-xl">&times;</button>`; 
        listContainer.appendChild(newRow); 
    }
    function handlePopulatePeriod() { 
        const start = document.getElementById('alloc-start-date').value, end = document.getElementById('alloc-end-date').value; 
        if (!start || !end) { showNotification('Selecione um intervalo de datas válido.', 'error'); return; }
        const startDate = new Date(start + 'T00:00:00'), endDate = new Date(end + 'T00:00:00'); 
        const includeWeekends = document.getElementById('alloc-weekends').checked; 
        const container = document.getElementById('allocation-calendar-container'); 
        const bulkRows = document.querySelectorAll('.bulk-alloc-row'); 
        if (isNaN(startDate.getTime()) || isNaN(endDate.getTime()) || startDate > endDate) { showNotification('Selecione um intervalo de datas válido.', 'error'); return; } 
        if (bulkRows.length === 0) { showNotification('Adicione pelo menos um projeto.', 'error'); return; } 
        const template = Array.from(bulkRows).map(row => ({ projectId: row.querySelector('.bulk-project-select').value, projectName: row.querySelector('.bulk-project-select').selectedOptions[0].text, hours: row.querySelector('.bulk-hours-input').value || 0 })); 
        let calendarHTML = '<div class="space-y-4">'; 
        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) { 
            if (includeWeekends || (d.getDay() !== 0 && d.getDay() !== 6)) { 
                const isoDate = d.toISOString().split('T')[0]; 
                let allocationsHTML = template.map(a => `<div class="flex items-center gap-2" data-project-id="${a.projectId}"><input type="text" value="${a.projectName}" disabled class="bg-slate-100 dark:bg-slate-700/50 border-0 text-sm rounded-lg block w-full p-2"><input type="number" value="${a.hours}" min="0" max="24" step="0.5" class="alloc-hours-input bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-sm rounded-lg block w-40 p-2"><button class="remove-alloc-row-btn text-red-500 hover:text-red-700 font-bold text-xl">&times;</button></div>`).join(''); 
                calendarHTML += `<div class="bg-slate-50 dark:bg-slate-800/50 p-3 rounded-lg border border-slate-200 dark:border-slate-700" data-date="${isoDate}"><p class="font-semibold">${d.toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: '2-digit' })}</p><div class="allocations-list mt-2 space-y-2">${allocationsHTML}</div></div>`; 
            } 
        } 
        calendarHTML += '</div><button id="save-allocations-btn" class="mt-6 w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-4 rounded-lg">Salvar Alocações em Lote</button>'; 
        container.innerHTML = calendarHTML; 
        document.querySelectorAll('#allocation-calendar-container [data-date]').forEach(updateDayValidationStyle); 
    }
    function handleAllocationInputChange(e) { if (e.target.classList.contains('alloc-hours-input')) updateDayValidationStyle(e.target.closest('[data-date]')); }
    function handleAllocationCalendarClick(e) { if (e.target.classList.contains('remove-alloc-row-btn')) { const dayCard = e.target.closest('[data-date]'); e.target.parentElement.remove(); updateDayValidationStyle(dayCard); } if (e.target.id === 'save-allocations-btn') validateAndSaveAllocations(); }
    function updateDayValidationStyle(dayCard) { if (!dayCard) return; const totalHours = Array.from(dayCard.querySelectorAll('.alloc-hours-input')).reduce((sum, input) => sum + (parseFloat(input.value) || 0), 0); dayCard.classList.toggle('overallocated', totalHours > state.data.settings.workHoursPerDay); }
    async function validateAndSaveAllocations() { 
        const professionalId = document.getElementById('alloc-professional').value;
        const dayCards = document.querySelectorAll('#allocation-calendar-container [data-date]');
        const allocationsToSave = [];
        dayCards.forEach(card => {
            const date = card.dataset.date;
            card.querySelectorAll('.allocations-list > div').forEach(row => {
                const projectId = row.dataset.projectId;
                const hours = parseFloat(row.querySelector('.alloc-hours-input').value);
                if(hours > 0) allocationsToSave.push({ professionalId, projectId, date, hours, type: 'hard' });
            });
        });
        if (allocationsToSave.length === 0) { showNotification('Nenhuma hora para salvar.', 'info'); return; }
        showConfirmationModal([`Salvar ${allocationsToSave.length} alocações para o profissional selecionado?`], async () => {
            try {
                const path = `artifacts/${state.appId}/users/${state.userId}/allocations`;
                for (const alloc of allocationsToSave) await addDoc(collection(state.db, path), alloc);
                showNotification('Alocações salvas com sucesso!', 'success');
                document.getElementById('allocation-calendar-container').innerHTML = '';
                document.getElementById('bulk-allocation-list').innerHTML = '';
            } catch (error) {
                console.error("Error saving batch allocations: ", error);
                showNotification('Erro ao salvar alocações.', 'error');
            }
        });
    }

    // --- AI, MODAL & INTEGRATION HANDLERS ---
    async function handlePipefySync() {
        showNotification('Iniciando sincronização com Pipefy...', 'info');
        await new Promise(resolve => setTimeout(resolve, 2000)); // Simulate API call
        const mockPipefyResponse = [
            { id: 34567, title: 'Calculadora da Reforma', current_phase: { name: 'Ativo' }, fields: [ { name: 'Cliente', value: 'Empresa A' }, { name: 'Valor do Negócio (Fees)', value: '120000' }, { name: 'Diretor', value: 'Carlos' }, { name: 'Tipo de Serviço', value: 'Consultoria' } ] },
            { id: 34570, title: 'Novo Projeto M&A', current_phase: { name: 'Proposta' }, fields: [ { name: 'Cliente', value: 'Empresa G' }, { name: 'Valor do Negócio (Fees)', value: '350000' }, { name: 'Diretor', value: 'Mariana' }, { name: 'Tipo de Serviço', value: 'M&A' } ] },
            { id: 34571, title: 'Auditoria Anual', current_phase: { name: 'Ganho' }, fields: [ { name: 'Cliente', value: 'Empresa D' }, { name: 'Valor do Negócio (Fees)', value: '180000' }, { name: 'Diretor', value: 'Ana' }, { name: 'Tipo de Serviço', value: 'Auditoria' } ] },
        ];
        try {
            const projectsPath = `artifacts/${state.appId}/users/${state.userId}/projects`;
            const projectsCollection = collection(state.db, projectsPath);
            let addedCount = 0;
            for(const card of mockPipefyResponse) {
                const existing = state.data.projects.find(p => p.pipefyId === card.id);
                if (!existing) {
                    const getField = (name) => card.fields.find(f => f.name.includes(name))?.value || null;
                    const newProject = {
                        pipefyId: card.id, name: card.title, status: card.current_phase.name, client: getField('Cliente'),
                        fees: parseFloat(getField('Fees')) || 0, director: getField('Diretor'), serviceType: getField('Tipo de Serviço'),
                        start: new Date().toISOString().split('T')[0], 
                        end: new Date(new Date().setMonth(new Date().getMonth() + 2)).toISOString().split('T')[0]
                    };
                    await addDoc(projectsCollection, newProject);
                    addedCount++;
                }
            }
            showNotification(`${addedCount} novos projetos sincronizados do Pipefy!`, 'success');
        } catch (error) {
            console.error("Error syncing with Pipefy:", error);
            showNotification('Erro ao sincronizar com o Pipefy.', 'error');
        }
    }
    async function handleGenerateProjectSummary(projectId, button) {
        const project = state.data.projects.find(p => p.id === projectId); if (!project) return;
        const container = document.getElementById('gemini-summary');
        button.disabled = true; container.innerHTML = '<div class="spinner mx-auto"></div>';
        const prompt = `Crie um resumo executivo em um parágrafo para o seguinte projeto: Nome: "${project.name}", Cliente: "${project.client}", Status: "${project.status}", Valor: R$${project.fees}, Diretor: ${project.director}.`;
        const summary = await callGeminiAPI(prompt);
        container.innerHTML = summary ? summary.replace(/\n/g, '<br>') : '<p class="text-red-500">Não foi possível gerar o resumo.</p>';
        button.disabled = false;
    }
    async function handleSuggestProjectTasks(projectId, button) {
        const project = state.data.projects.find(p => p.id === projectId); if (!project) return;
        const container = document.getElementById('gemini-tasks');
        button.disabled = true; container.innerHTML = '<div class="spinner mx-auto"></div>';
        const prompt = `Liste 5 a 7 tarefas iniciais essenciais para um projeto de "${project.serviceType || 'consultoria'}" chamado "${project.name}".`;
        const schema = { type: "OBJECT", properties: { tasks: { type: "ARRAY", items: { type: "STRING" } } } };
        const result = await callGeminiAPI(prompt, schema);
        if (result && result.tasks) {
            container.innerHTML = `<h5 class="font-semibold mb-2">Tarefas Sugeridas:</h5><ul class="list-disc list-inside space-y-1">${result.tasks.map(t => `<li>${t}</li>`).join('')}</ul>`;
        } else { container.innerHTML = '<p class="text-red-500">Não foi possível sugerir tarefas.</p>'; }
        button.disabled = false;
    }
    async function handleAddComment(projectId) {
        const input = document.getElementById('new-comment-input'); if (!input) return;
        const text = input.value.trim(); if (!text) return;
        const newComment = { projectId, author: state.currentUser.isAnonymous ? 'Anônimo' : (state.currentUser.displayName || 'Usuário'), timestamp: new Date().toISOString(), text };
        try {
            const path = `artifacts/${state.appId}/users/${state.userId}/comments`;
            await addDoc(collection(state.db, path), newComment);
            input.value = '';
            showNotification('Comentário adicionado!', 'success');
        } catch (error) {
            console.error("Error adding comment: ", error);
            showNotification('Erro ao adicionar comentário.', 'error');
        }
    }
    function renderComments(projectId) {
        const container = document.getElementById('project-comments-container'); if (!container) return;
        const commentsForProject = state.data.comments.filter(c => c.projectId === projectId).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        if (commentsForProject.length === 0) { container.innerHTML = '<p class="text-sm text-slate-500 text-center">Nenhum comentário ainda.</p>'; return; }
        container.innerHTML = commentsForProject.map(comment => `
            <div class="flex items-start space-x-3"><div class="flex-shrink-0 w-8 h-8 bg-slate-200 dark:bg-slate-700 rounded-full flex items-center justify-center font-bold text-sm">${comment.author.charAt(0)}</div>
                <div class="flex-1"><div class="bg-slate-100 dark:bg-slate-700/50 rounded-lg p-3"><p class="font-semibold text-sm">${comment.author}</p><p class="text-sm">${comment.text}</p></div>
                    <p class="text-xs text-slate-400 mt-1">${new Date(comment.timestamp).toLocaleString('pt-BR')}</p>
                </div></div>`).join('');
    }
    async function handleCapacityAnalysis(e) {
        const button = e.target;
        const container = document.getElementById('gemini-capacity-analysis');
        button.disabled = true;
        container.innerHTML = '<div class="flex items-center gap-2"><div class="spinner"></div><p>Analisando dados...</p></div>';
        container.classList.remove('hidden');
        const dataSummary = state.data.capacityData.labels.map((month, i) => `${month}: ${state.data.capacityData.allocated[i]}h alocadas de ${state.data.capacityData.totalCapacity[i]}h disponíveis`).join('; ');
        const prompt = `Como um gerente de projetos sênior, analise os seguintes dados de capacidade e alocação para os próximos meses e escreva um breve relatório (2-3 parágrafos) sobre os riscos e pontos de atenção. Dados: ${dataSummary}.`;
        const analysis = await callGeminiAPI(prompt);
        container.innerHTML = analysis ? analysis.replace(/\n/g, '<br><br>') : '<p class="text-red-500">Não foi possível gerar a análise.</p>';
        button.disabled = false;
    }
    async function handleGenerateForecast(e) {
        const button = e.target;
        button.disabled = true;
        const placeholder = document.getElementById('forecast-placeholder');
        const content = document.getElementById('forecast-content');
        placeholder.innerHTML = '<div class="flex items-center justify-center gap-2"><div class="spinner"></div><p>Gerando forecast com IA...</p></div>';
        const pipelineData = state.data.projects.filter(p => p.status === 'Proposta' || p.status === 'Ganho').map(p => ({ name: p.name, value: p.fees, status: p.status, endDate: p.end }));
        const prompt = `Como analista financeiro, crie um forecast de receita para os próximos 2 trimestres (Q3 e Q4 2025) com base no pipeline de projetos a seguir: ${JSON.stringify(pipelineData)}. Assuma uma taxa de conversão de 75% para projetos em "Proposta". Distribua a receita dos projetos "Ganhos" pelos meses de duração. Forneça a receita total prevista para cada trimestre e uma análise curta sobre a saúde do pipeline.`;
        const schema = { type: "OBJECT", properties: { q3_revenue: { type: "NUMBER" }, q4_revenue: { type: "NUMBER" }, analysis: { type: "STRING" } } };
        const result = await callGeminiAPI(prompt, schema);
        placeholder.classList.add('hidden');
        content.classList.remove('hidden');
        if (result) {
            document.getElementById('forecast-kpis').innerHTML = `<div class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-lg"><h4 class="text-sm font-medium text-slate-500">Receita Prevista Q3 2025</h4><p class="text-2xl font-bold text-primary-600 mt-1">R$ ${result.q3_revenue.toLocaleString('pt-BR')}</p></div><div class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-lg"><h4 class="text-sm font-medium text-slate-500">Receita Prevista Q4 2025</h4><p class="text-2xl font-bold text-primary-600 mt-1">R$ ${result.q4_revenue.toLocaleString('pt-BR')}</p></div>`;
            document.getElementById('gemini-forecast-analysis').innerHTML = `<h4 class="font-semibold mb-2">Análise da IA:</h4><p>${result.analysis.replace(/\n/g, '<br>')}</p>`;
            const ctx = document.getElementById('forecastChart').getContext('2d');
            if(charts.forecast) charts.forecast.destroy();
            charts.forecast = new Chart(ctx, { type: 'line', data: { labels: ['Q2', 'Q3 (Prev)', 'Q4 (Prev)'], datasets: [{ label: 'Receita', data: [750000, result.q3_revenue, result.q4_revenue], borderColor: '#f59e0b', tension: 0.1, fill: false }] }, options: { responsive: true, maintainAspectRatio: false } });
        } else { content.innerHTML = '<p class="text-red-500 text-center">Não foi possível gerar o forecast.</p>'; }
        button.disabled = false;
    }
    function openProjectModal(projectId) {
        ui.projectModal.dataset.currentProject = projectId;
        const project = state.data.projects.find(p => p.id === projectId); if (!project) return;
        ui.projectModalContent.innerHTML = `<div class="flex flex-col h-[80vh]"><div class="p-6 border-b dark:border-slate-700"><div class="flex justify-between items-start"><div><p class="text-xs font-semibold uppercase text-primary-500">${project.status}</p><h2 class="text-2xl font-bold mt-1">${project.name}</h2><p class="text-slate-500 dark:text-slate-400">${project.client}</p></div><button id="close-modal-btn" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 text-2xl">&times;</button></div></div><div class="border-b border-slate-200 dark:border-slate-700"><nav class="-mb-px flex space-x-6 px-6"><button class="modal-tab-btn active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="details">Detalhes e IA</button><button class="modal-tab-btn text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200 dark:hover:border-gray-500 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="history">Histórico</button></nav></div><div class="flex-1 overflow-y-auto p-6 space-y-6"><div class="modal-tab-content" id="modal-tab-details"><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="md:col-span-2 space-y-4"><div><h4 class="font-semibold">Equipe</h4><p>Diretor: ${project.director || 'N/A'} | MD: ${project.md || 'N/A'} | SD: ${project.sd || 'N/A'}</p></div><div><h4 class="font-semibold">Cronograma</h4><p>${project.start ? new Date(project.start + 'T00:00:00').toLocaleDateString() : 'N/A'} - ${project.end ? new Date(project.end + 'T00:00:00').toLocaleDateString() : 'N/A'}</p></div></div><div class="text-center bg-slate-100 dark:bg-slate-700/50 p-4 rounded-lg"><h4 class="font-semibold">Valor</h4><p class="text-3xl font-bold text-primary-600 dark:text-primary-400 mt-2">R$ ${project.fees.toLocaleString('pt-BR')}</p></div></div><div class="border-t dark:border-slate-700 pt-4 mt-6"><h4 class="font-semibold mb-3">✨ Assistente de Projeto</h4><div class="flex flex-wrap gap-2 mb-4"><button id="gemini-summary-btn" class="text-sm bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg">Gerar Resumo</button><button id="gemini-tasks-btn" class="text-sm bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg">Sugerir Tarefas</button></div><div id="gemini-summary" class="text-sm p-3 bg-slate-50 dark:bg-slate-700/50 rounded-lg min-h-[50px]"></div><div id="gemini-tasks" class="text-sm mt-3 p-3 bg-slate-50 dark:bg-slate-700/50 rounded-lg min-h-[50px]"></div></div></div><div class="modal-tab-content hidden" id="modal-tab-history"><div id="project-comments-container" class="space-y-4"></div><div class="mt-4 border-t dark:border-slate-700 pt-4"><textarea id="new-comment-input" class="w-full bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg p-2 text-sm" placeholder="Adicionar um comentário..."></textarea><div class="flex justify-between items-center mt-2"><button id="add-comment-btn" class="bg-primary-600 hover:bg-primary-700 text-white font-semibold py-2 px-4 rounded-lg text-sm">Enviar</button></div></div></div></div></div>`;
        ui.projectModal.classList.remove('hidden'); ui.projectModal.classList.add('flex');
        setTimeout(() => ui.projectModalContent.classList.remove('scale-95', 'opacity-0'), 10);
        document.getElementById('close-modal-btn').addEventListener('click', closeProjectModal);
        document.getElementById('gemini-summary-btn').addEventListener('click', (e) => handleGenerateProjectSummary(projectId, e.target));
        document.getElementById('gemini-tasks-btn').addEventListener('click', (e) => handleSuggestProjectTasks(projectId, e.target));
        document.getElementById('add-comment-btn').addEventListener('click', () => handleAddComment(projectId));
        document.querySelectorAll('.modal-tab-btn').forEach(btn => btn.addEventListener('click', (e) => {
            document.querySelectorAll('.modal-tab-btn').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            document.querySelectorAll('.modal-tab-content').forEach(c => c.classList.toggle('hidden', c.id !== `modal-tab-${e.target.dataset.tab}`));
        }));
        renderComments(projectId);
    }
    function closeProjectModal() { ui.projectModalContent.classList.add('scale-95', 'opacity-0'); setTimeout(() => { ui.projectModal.classList.add('hidden'); ui.projectModalContent.innerHTML = ''; ui.projectModal.removeAttribute('data-current-project'); }, 300); }
    
    // --- DASHBOARD & PLANNER INTERACTIVITY ---
    function setupPersonalizeMenu() { ui.widgetTogglesContainer.innerHTML = ''; widgets.forEach(widget => { const config = state.dashboardLayout.widgets[widget.id]; if (!config) return; const isLarge = config.size.includes('col-span-2'); const isChart = widget.type === 'chart'; const controlHTML = `<div class="space-y-2 py-3 border-b border-slate-200 dark:border-slate-700 last:border-b-0"><div class="flex items-center justify-between"><label for="toggle-${widget.id}" class="text-sm font-medium cursor-pointer">${widget.title}</label><input type="checkbox" id="toggle-${widget.id}" class="widget-toggle" data-widget-id="${widget.id}" ${config.visible ? 'checked' : ''}></div><div class="flex items-center justify-end gap-2 ${config.visible ? '' : 'hidden'}"><span class="text-xs text-slate-500">Tamanho:</span><button data-widget-id="${widget.id}" data-size="small" class="widget-size-btn text-xs px-2 py-1 rounded ${!isLarge ? 'bg-primary-500 text-white' : 'bg-slate-200 dark:bg-slate-700'}">P</button><button data-widget-id="${widget.id}" data-size="large" class="widget-size-btn text-xs px-2 py-1 rounded ${isLarge ? 'bg-primary-500 text-white' : 'bg-slate-200 dark:bg-slate-700'}" ${!isChart ? 'disabled opacity-50 cursor-not-allowed' : ''}>G</button></div></div>`; ui.widgetTogglesContainer.innerHTML += controlHTML; }); ui.widgetTogglesContainer.querySelectorAll('.widget-toggle').forEach(toggle => { toggle.addEventListener('change', (e) => { state.dashboardLayout.widgets[e.target.dataset.widgetId].visible = e.target.checked; saveAndRerenderDashboard(); setupPersonalizeMenu(); }); }); ui.widgetTogglesContainer.querySelectorAll('.widget-size-btn').forEach(button => { button.addEventListener('click', (e) => { const widgetId = e.target.dataset.widgetId; const size = e.target.dataset.size; state.dashboardLayout.widgets[widgetId].size = size === 'small' ? 'col-span-1 md:col-span-1' : 'col-span-1 md:col-span-2'; saveAndRerenderDashboard(); setupPersonalizeMenu(); }); }); }
    function saveAndRerenderDashboard() { localStorage.setItem('dashboardLayout', JSON.stringify(state.dashboardLayout)); renderDashboard(); }
    function setupDragAndDrop() { new Sortable(ui.dashboardGrid, { animation: 150, ghostClass: 'widget-placeholder', onEnd: function (evt) { const newOrder = Array.from(ui.dashboardGrid.children).map(item => item.dataset.id); state.dashboardLayout.order = newOrder; saveAndRerenderDashboard(); }, }); }
    function setupPlannerDragAndDrop() {
        document.querySelectorAll('.planner-cell').forEach(cell => {
            new Sortable(cell, { group: 'planner', animation: 150,
                onAdd: function (evt) {
                    const projectId = evt.item.dataset.projectId;
                    const professionalId = evt.to.dataset.professionalId;
                    const date = evt.to.dataset.date;
                    showAllocationHoursModal(projectId, professionalId, date, (hours, type) => {
                        if (hours > 0) handleAddAllocation(projectId, professionalId, date, hours, type);
                    });
                    evt.item.remove();
                }
            });
        });
    }
    function showAllocationHoursModal(projectId, professionalId, date, onConfirm) {
        const project = state.data.projects.find(p => p.id === projectId);
        const professional = state.data.professionals.find(p => p.id === professionalId);
        ui.projectModalContent.innerHTML = `<div class="p-6"><div class="flex justify-between items-start"><h2 class="text-xl font-bold">Alocar Horas</h2><button id="close-alloc-modal-btn" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 text-2xl">&times;</button></div><div class="mt-4 space-y-4"><div><p><span class="font-semibold">Data:</span> ${new Date(date + 'T00:00:00').toLocaleDateString('pt-BR')}</p><p><span class="font-semibold">Profissional:</span> ${professional.name}</p><p><span class="font-semibold">Projeto:</span> ${project.name}</p></div><div><label for="alloc-hours" class="block text-sm font-medium mb-1">Horas a alocar</label><input type="number" id="alloc-hours" value="4" min="0.5" max="24" step="0.5" class="w-full bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg p-2"></div><div><p class="block text-sm font-medium mb-2">Tipo de Alocação</p><div class="flex gap-4"><label class="flex items-center gap-2"><input type="radio" name="alloc-type" value="hard" checked class="h-4 w-4"> <span>Confirmada</span></label><label class="flex items-center gap-2"><input type="radio" name="alloc-type" value="soft" class="h-4 w-4"> <span>Provisória</span></label></div></div><div class="flex justify-end gap-3 mt-6"><button id="cancel-alloc-btn" class="px-4 py-2 bg-slate-200 dark:bg-slate-700 rounded-lg">Cancelar</button><button id="confirm-alloc-btn" class="px-4 py-2 bg-primary-600 text-white rounded-lg">Salvar</button></div></div></div>`;
        ui.projectModal.classList.remove('hidden'); ui.projectModal.classList.add('flex');
        setTimeout(() => ui.projectModalContent.classList.remove('scale-95', 'opacity-0'), 10);
        const closeModal = () => { ui.projectModalContent.classList.add('scale-95', 'opacity-0'); setTimeout(() => { ui.projectModal.classList.add('hidden'); ui.projectModalContent.innerHTML = ''; }, 300); };
        document.getElementById('confirm-alloc-btn').onclick = () => { const hours = document.getElementById('alloc-hours').value; const type = document.querySelector('input[name="alloc-type"]:checked').value; onConfirm(hours, type); closeModal(); };
        document.getElementById('cancel-alloc-btn').onclick = closeModal;
        document.getElementById('close-alloc-modal-btn').onclick = closeModal;
    }

    // --- AUTHENTICATION & INITIALIZATION ---
    function updateUserUI() {
        if (state.currentUser) {
            ui.loginBtn.style.display = 'none';
            ui.userProfile.style.display = 'flex';
            ui.userName.textContent = state.currentUser.isAnonymous ? 'Usuário Anônimo' : (state.currentUser.displayName || 'Usuário');
            ui.userPhoto.src = state.currentUser.photoURL || `https://placehold.co/40x40/cbd5e1/ffffff?text=${state.currentUser.uid.substring(0,1).toUpperCase()}`;
        } else {
            ui.loginBtn.style.display = 'flex';
            ui.userProfile.style.display = 'none';
        }
    }
    function populateAllDropdowns() {
        const professionalDropdowns = document.querySelectorAll('#alloc-professional, #cleanup-professional');
        const projectDropdowns = document.querySelectorAll('#cleanup-project');
        if (state.data.professionals.length > 0) professionalDropdowns.forEach(dd => { dd.innerHTML = state.data.professionals.map(p => `<option value="${p.id}">${p.name}</option>`).join(''); });
        if (state.data.projects.length > 0) projectDropdowns.forEach(dd => { dd.innerHTML = '<option value="">Todos</option>' + state.data.projects.map(p => `<option value="${p.id}">${p.name}</option>`).join(''); });
    }
    async function initFirebase() {
        try {
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            if (!firebaseConfig.apiKey) {
                ui.loadingOverlay.innerHTML = '<p class="text-red-400 text-lg">Configuração do Firebase não encontrada.</p>';
                return;
            }
            const app = initializeApp(firebaseConfig);
            state.db = getFirestore(app);
            state.auth = getAuth(app);
            // setLogLevel('debug'); // Uncomment for development
            onAuthStateChanged(state.auth, (user) => {
                state.currentUser = user;
                if (user) {
                    state.userId = user.uid;
                    updateUserUI();
                    setupDataListeners();
                    ui.loadingOverlay.classList.add('opacity-0');
                    setTimeout(() => ui.loadingOverlay.style.display = 'none', 300);
                }
            });
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(state.auth, __initial_auth_token);
            } else {
                await signInAnonymously(state.auth);
            }
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            ui.loadingOverlay.innerHTML = `<p class="text-red-400 text-lg text-center max-w-sm">Falha na conexão com o Firebase. Verifique a configuração do projeto e as regras de segurança do Firestore.</p>`;
        }
    }
    function initApp() {
        applyTheme();
        switchView(state.currentView);
        renderAllViews();
        setupEventListeners();
        setupDragAndDrop();
        setupPersonalizeMenu();
        ui.personalizeBtn.addEventListener('click', () => ui.personalizeMenu.classList.toggle('hidden'));
        document.addEventListener('click', e => { if (ui.personalizeContainer && !ui.personalizeContainer.contains(e.target)) ui.personalizeMenu.classList.add('hidden'); });
        ui.projectModal.addEventListener('click', e => { if (e.target === ui.projectModal) closeProjectModal(); });
    }
    
    // --- APP START ---
    initApp();
    initFirebase();
</script>

</body>
</html>

