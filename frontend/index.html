<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PMO Pro — Painel</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    :root { --bg: #0f172a; --panel: #0b1220; --muted: #94a3b8; --accent: #7c3aed; }
    html,body,#root{height:100%}
    body{font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:linear-gradient(180deg,#071128 0%,#07121a 100%); color:#e6eef8}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02)); border:1px solid rgba(255,255,255,0.04); border-radius:12px; padding:1rem}
    .muted{color:var(--muted)}
    .accent{color:var(--accent)}
    .btn{background:linear-gradient(90deg,#6d28d9,#a78bfa); color:white; padding:0.5rem 0.75rem; border-radius:8px}
    .ghost{background:transparent; border:1px solid rgba(255,255,255,0.04); padding:0.4rem 0.6rem; border-radius:8px}
    .small{font-size:0.85rem}
    .sidebar{width:260px}
    .scroll-y{max-height:60vh; overflow:auto}
  </style>
</head>

<body>
  <div id="root" class="h-full grid grid-cols-[260px_1fr] gap-6 p-6">
    <aside class="sidebar">
      <div class="mb-6">
        <h1 class="text-2xl font-bold">PMO Pro</h1>
        <p class="muted small">Visão geral & controle</p>
      </div>
      <nav class="space-y-2">
        <button class="w-full text-left p-3 card" id="nav-dashboard">Dashboard</button>
        <button class="w-full text-left p-3 card" id="nav-projects">Projetos</button>
        <button class="w-full text-left p-3 card" id="nav-allocations">Alocações</button>
        <button class="w-full text-left p-3 card" id="nav-kanban">Kanban</button>
        <button class="w-full text-left p-3 card" id="nav-settings">Configurações</button>
      </nav>
      <div class="mt-6">
        <button class="btn" id="btn-sync">Sincronizar Pipefy</button>
        <div class="mt-3">
          <button id="btn-add-prof" class="ghost" style="width:100%">➕ Adicionar Profissional</button>
        </div>
      </div>
    </aside>

    <main>
      <header class="flex items-center justify-between mb-6">
        <div>
          <h2 id="page-title" class="text-xl font-semibold">Dashboard</h2>
          <p class="muted small" id="page-sub">Resumo do projeto</p>
        </div>
        <div class="flex items-center gap-3">
          <div class="muted small">Ambiente: <span id="env-label">PROD</span></div>
          <button class="ghost" id="btn-refresh">Atualizar</button>
        </div>
      </header>

      <section class="grid grid-cols-3 gap-6">
        <div class="col-span-2 space-y-4">
          <div class="card">
            <div class="flex items-center justify-between mb-3">
              <h3 class="font-semibold">Visão geral</h3>
              <div class="muted small">Últimas 24h</div>
            </div>
            <canvas id="overviewChart" height="120"></canvas>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div class="card">
              <h4 class="font-medium">Projetos ativos</h4>
              <div id="active-count" class="text-2xl font-bold mt-2">—</div>
              <div class="muted small mt-1">Total de projetos que estão em andamento</div>
            </div>
            <div class="card">
              <h4 class="font-medium">Horas estimadas</h4>
              <div id="est-hours" class="text-2xl font-bold mt-2">—</div>
              <div class="muted small mt-1">Soma das estimativas</div>
            </div>
          </div>
        </div>

        <aside class="space-y-4">
          <div class="card">
            <h4 class="font-medium">Top projetos</h4>
            <ul id="top-list" class="mt-3 space-y-2 small muted scroll-y"></ul>
          </div>

          <div class="card">
            <h4 class="font-medium">Status</h4>
            <div id="status-breakdown" class="mt-3 small muted"></div>
          </div>
        </aside>
      </section>

      <section class="mt-6 card">
        <h3 class="font-semibold mb-3">Projetos</h3>
        <div id="projects-table" class="space-y-2"></div>
      </section>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>

  <script>
    // Simple SPA wiring to existing backend endpoints
    const api = {
      get: (path)=>fetch('/api'+path).then(r=>r.json()),
      post: (path, body)=>fetch('/api'+path, {method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(body)}).then(r=>r.json())
    }

    // State
    const state = { projects: [] }

    // Elements
    const el = id=>document.getElementById(id)
    const nav = {
      dashboard: el('nav-dashboard'), projects: el('nav-projects'), allocations: el('nav-allocations'), kanban: el('nav-kanban'), settings: el('nav-settings')
    }

    // Routing (very small)
    nav.dashboard.addEventListener('click', ()=>showPage('dashboard'))
    nav.projects.addEventListener('click', ()=>showPage('projects'))
    el('btn-sync').addEventListener('click', async ()=>{
      el('btn-sync').innerText='Sincronizando...'
      try{
        const res = await api.post('/sync/pipefy')
        alert('Sync completo: '+JSON.stringify(res))
        loadData()
      }catch(e){
        alert('Erro no sync')
      }finally{el('btn-sync').innerText='Sincronizar Pipefy'}
    })

    el('btn-refresh').addEventListener('click', ()=>loadData())

    // quick-add professional (prompts) — includes hourly_rate support
    document.getElementById('btn-add-prof')?.addEventListener('click', async ()=>{
      const name = prompt('Nome do profissional:')?.trim();
      if(!name) return alert('Nome é obrigatório');
      const email = prompt('Email (opcional):')?.trim() || null;
      const role = prompt('Função / cargo (opcional):')?.trim() || null;
      const hr = prompt('Taxa por hora (ex: 120.50) — opcional:')?.trim() || null;
      let hourly_rate = null;
      if(hr){
        const n = Number(hr.replace(',', '.'));
        if(!Number.isFinite(n)) return alert('Taxa inválida');
        hourly_rate = n;
      }
      try{
        const res = await fetch('/api/professionals', { method: 'POST', headers: {'content-type':'application/json'}, body: JSON.stringify({ name, email, role, hourly_rate }) });
        const j = await res.json();
        if(!res.ok) throw new Error(j.error || 'erro');
        alert('Profissional criado: ' + (j.name || j.id || 'OK'));
      }catch(e){
        alert('Erro ao criar profissional: '+e.message);
      }
    })

    function showPage(page){
      el('page-title').innerText = page === 'dashboard' ? 'Dashboard' : page === 'projects' ? 'Projetos' : 'PMO'
      // simple
    }

    async function loadData(){
      try{
        const projectsRes = await fetch('/api/projects').then(r=>r.json())
        state.projects = projectsRes.data || projectsRes || []
        renderProjects()
        renderOverview()
      }catch(e){
        console.warn('failed load', e)
      }
    }

    function renderProjects(){
      const container = el('projects-table')
      container.innerHTML = ''
      if(!state.projects.length) container.innerHTML = '<div class="muted">Nenhum projeto encontrado</div>'
      state.projects.slice(0,50).forEach(p=>{
        const div = document.createElement('div')
        div.className='p-3 border-b border-white/5 flex items-center justify-between'
        div.innerHTML = `<div><div class="font-medium">${escapeHtml(p.name||'—')}</div><div class="muted small">${escapeHtml(p.pipefy_status||'--')}</div></div><div class="muted small">${escapeHtml(p.pipefy_owner_email||'—')}</div>`
        container.appendChild(div)
      })
    }

    function renderOverview(){
      const totals = state.projects.reduce((acc,p)=>{acc.active += (p.pipefy_status!=='done' && p.pipefy_status?1:0); acc.hours += Number(p.estimated_hours||0); return acc},{active:0,hours:0})
      el('active-count').innerText = totals.active
      el('est-hours').innerText = totals.hours.toFixed(1)

      // top list
      const top = state.projects.slice().sort((a,b)=> (Number(b.estimated_hours||0)-Number(a.estimated_hours||0))).slice(0,5)
      el('top-list').innerHTML = top.map(t=>`<li class="flex justify-between"><span>${escapeHtml(t.name||'—')}</span><span class="muted small">${Number(t.estimated_hours||0).toFixed(1)}h</span></li>`).join('')

      // chart
      const ctx = document.getElementById('overviewChart').getContext('2d')
      if(window._overviewChart) window._overviewChart.destroy()
      window._overviewChart = new Chart(ctx, {type:'line', data:{labels:state.projects.slice(0,10).map(p=>p.name||'—'), datasets:[{label:'Horas', data:state.projects.slice(0,10).map(p=>Number(p.estimated_hours||0)), borderColor:'#7c3aed', backgroundColor:'rgba(124,58,237,0.2)'}]}, options:{responsive:true, maintainAspectRatio:false}})
    }

    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])) }

    // init
    (function(){
      fetch('/api').catch(()=>{})
      loadData()
    })()
  </script>
</body>

</html>
